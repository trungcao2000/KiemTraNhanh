import React, { useState, useRef } from 'react';
import {
    View,
    Text,
    TouchableOpacity,
    TextInput, ScrollView, Modal, Image, Alert
} from 'react-native';
import ViewShot from 'react-native-view-shot';
import * as MediaLibrary from 'expo-media-library';
import { styles } from './Style';

export const Hocsinh = ({ students = [], setStudents }) => {
    const [numStudents, setNumStudents] = useState('');
    const [name, setName] = useState('');
    const [pendingStudents, setPendingStudents] = useState([]);
    const [editingIndex, setEditingIndex] = useState(null);
    const [allQRs, setAllQRs] = useState([]);
    const [visible, setVisible] = useState(false);

    const viewShotRef = useRef();

    // const addOrUpdateStudent = () => {
    //     if (!name.trim()) return;

    //     // Ki·ªÉm tra t√™n c√≥ t·ªìn t·∫°i trong danh s√°ch h·ªçc sinh ƒë√£ th√™m ho·∫∑c ƒëang ch·ªù
    //     const isNameExist = [...students, ...pendingStudents].some(student => student.name.trim().toLowerCase() === name.trim().toLowerCase());

    //     if (isNameExist) {
    //         alert('T√™n n√†y ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn t√™n kh√°c.');
    //         return;
    //     }

    //     if (editingIndex !== null) {
    //         // S·ª≠a tr·ª±c ti·∫øp trong students
    //         const updated = [...students];
    //         updated[editingIndex] = { name };
    //         setStudents(updated);
    //         setEditingIndex(null);
    //     } else {
    //         // Th√™m v√†o pending n·∫øu kh√¥ng ƒëang s·ª≠a
    //         setPendingStudents([...pendingStudents, { name }]);
    //     }

    //     setName('');
    // };


    // const confirmAddStudents = () => {
    //     setStudents([...students, ...pendingStudents]);
    //     setPendingStudents([]);
    //     setName('');
    // };

    const removeStudent = (index) => {
        const updated = [...students];
        updated.splice(index, 1);
        setStudents(updated);
        if (editingIndex === index) {
            setEditingIndex(null);
            setName('');
        }
    };

    // H√†m t·∫°o m·∫£ng h·ªçc sinh t·ª´ 1 ƒë·∫øn s·ªë nh·∫≠p v√†o

    const generateQRSetForOne = (student) => {
        const qrSet = ['A', 'B', 'C', 'D'].map((ans) => {
            const json = {
                name: student.name,
                answer: ans,
            };
            return {
                answer: ans,
                uri: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(JSON.stringify(json))}`
            };
        });
        return qrSet;
    };

    const generateAllQRs = () => {
        const result = students.map(student => ({
            name: student.name,
            qrs: generateQRSetForOne(student)
        }));
        setAllQRs(result);
        setVisible(true);
    };

    const downloadAllQRs = async () => {
        try {
            const permission = await MediaLibrary.requestPermissionsAsync();
            if (!permission.granted) {
                Alert.alert("C·∫ßn quy·ªÅn truy c·∫≠p ·∫£nh ƒë·ªÉ l∆∞u m√£ QR.");
                return;
            }

            const uri = await viewShotRef.current.capture(); // ch·ª•p ·∫£nh m√†n
            const asset = await MediaLibrary.createAssetAsync(uri);
            await MediaLibrary.createAlbumAsync("QR Codes", asset, false);

            Alert.alert("‚úÖ ƒê√£ l∆∞u ·∫£nh to√†n b·ªô m√£ QR");
        } catch (error) {
            console.error("L·ªói khi l∆∞u ·∫£nh:", error);
            Alert.alert("‚ùå L·ªói khi l∆∞u ·∫£nh.");
        }
    };

    const filteredStudents = Array.isArray(students)
        ? students.filter(student =>
            student.name && typeof student.name === 'string' &&
            student.name.toLowerCase().includes(name.toLowerCase())
        )
        : [];

    const generateStudents = () => {
        const number = parseInt(numStudents);
        if (isNaN(number) || number <= 0) {
            Alert.alert('Vui l√≤ng nh·∫≠p m·ªôt s·ªë h·ª£p l·ªá');
            return;
        }

        const studentArray = [];
        for (let i = 1; i <= number; i++) {
            studentArray.push(`${i}. `); // T·∫°o t√™n h·ªçc sinh theo s·ªë index
        }
        setStudents(studentArray); // L∆∞u m·∫£ng h·ªçc sinh v√†o state
    };
    return (

        <View style={styles.center}>
            <Text style={styles.title}>
                T·∫°o Nhanh Theo S·ªë L∆∞·ª£ng H·ªçc Sinh
            </Text>
            <View style={styles.buttonContainer}>
                <TextInput
                    style={styles.textInput}
                    placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng h·ªçc sinh"
                    keyboardType="numeric"
                    value={numStudents}
                    onChangeText={setNumStudents}
                />
                <TouchableOpacity
                    onPress={generateStudents}
                    style={styles.button}
                >
                    <Text style={styles.buttonText}>
                        {`T·∫°o S·ªë L∆∞·ª£ng ${numStudents}`}
                    </Text>
                </TouchableOpacity>
            </View>
            {/* <TextInput
                placeholder="T·∫°o m·ªõi, t√¨m theo t√™n..."
                value={name}
                onChangeText={setName}
                style={styles.textInput}
            />
            <TouchableOpacity
                onPress={addOrUpdateStudent}
                style={styles.button}
            >
                <Text style={styles.buttonText}>
                    {editingIndex !== null ? 'C·∫≠p nh·∫≠t' : 'Th√™m h·ªçc sinh v√†o danh s√°ch t·∫°m'}
                </Text>
            </TouchableOpacity> */}

            {/* {pendingStudents.length > 0 && (
                <TouchableOpacity
                    onPress={confirmAddStudents}
                    style={styles.button}
                >
                    <Text style={styles.buttonText}>
                        ‚úÖ X√°c nh·∫≠n th√™m {pendingStudents.length} h·ªçc sinh
                    </Text>
                </TouchableOpacity>
            )} */}
            {/* T·∫°o QR cho t·∫•t c·∫£ */}
            {students.length > 0 && (
                <View style={styles.buttonContainer}>

                    <TouchableOpacity
                        onPress={generateAllQRs}
                        style={styles.button}
                    >
                        <Text style={styles.buttonText}>
                            üî≥ T·∫°o t·∫•t c·∫£ m√£ QR
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        onPress={() => setStudents([])}
                        style={[styles.button, { backgroundColor: '#f44336' }]}
                    >
                        <Text style={styles.buttonText}>üóëÔ∏è Xo√° H·∫øt</Text>
                    </TouchableOpacity>
                </View>
            )}


            {/* Danh s√°ch ch·ªù */}
            {/* {pendingStudents.length > 0 && (
                <View style={styles.center}>
                    <Text style={styles.title}>
                        üìù Danh s√°ch ch·ªù x√°c nh·∫≠n:
                    </Text>
                    {pendingStudents.map((student, index) => (
                        <View
                            key={index}
                            style={{
                                flexDirection: 'row',
                                justifyContent: 'space-between',
                                backgroundColor: '#e0f7fa',
                                borderRadius: 8,
                                padding: 12,
                                marginBottom: 6,
                            }}
                        >
                            <Text>{student.name}</Text>
                            <View style={{ flexDirection: 'row' }}>
                                <TouchableOpacity
                                    onPress={() => {
                                        setEditingIndex(index);
                                        setName(student.name);
                                    }}
                                    style={styles.button}
                                >
                                    <Text style={styles.buttonText}>‚úèÔ∏è S·ª≠a</Text>
                                </TouchableOpacity>
                                <TouchableOpacity
                                    onPress={() => {
                                        const updated = [...pendingStudents];
                                        updated.splice(index, 1);
                                        setPendingStudents(updated);
                                    }}
                                    style={styles.button}
                                >
                                    <Text style={styles.buttonText}>üóëÔ∏è Xo√°</Text>
                                </TouchableOpacity>
                            </View>
                        </View>
                    ))}
                </View>
            )} */}

            <Text style={styles.title}>
                Danh s√°ch h·ªçc sinh
            </Text>
            <View style={{
                backgroundColor: '#fff',
            }}>

                {/* Danh s√°ch ch√≠nh */}
                {students.map((student, index) => (
                    <View
                        key={index}
                        style={{

                            borderRadius: 8,
                            padding: 12,
                            marginTop: 8,
                        }}
                    >
                        {/* D√≤ng t√™n h·ªçc sinh */}
                        <Text style={{ marginBottom: 8, fontWeight: 'bold', fontSize: 16 }}>{student}</Text>

                        {/* D√≤ng ch·ª©c nƒÉng */}
                        <View style={{ flexDirection: 'row', justifyContent: 'flex-start', flexWrap: 'wrap', gap: 8 }}>
                            <TouchableOpacity
                                onPress={() => removeStudent(index)}
                                style={[styles.button, { backgroundColor: '#f44336' }]}
                            >
                                <Text style={styles.buttonText}>üóëÔ∏è Xo√°</Text>
                            </TouchableOpacity>
                            <TouchableOpacity
                                onPress={() => {
                                    setAllQRs([{ name: student.name, qrs: generateQRSetForOne(student) }]);
                                    setVisible(true);
                                }}
                                style={[styles.button, { backgroundColor: '#4CAF50' }]}
                            >
                                <Text style={styles.buttonText}>üî≥ T·∫°o m√£</Text>
                            </TouchableOpacity>
                        </View>
                    </View>
                ))}

            </View>


            {/* Modal QR */}
            <Modal visible={visible} transparent animationType="slide">
                <View style={{
                    flex: 1,
                    backgroundColor: '#000000aa',
                    justifyContent: 'center',
                }}>
                    <View style={{
                        backgroundColor: '#fff',
                        margin: 20,
                        borderRadius: 10,
                        padding: 16,
                        maxHeight: '80%',
                    }}>
                        <ScrollView>
                            <ViewShot ref={viewShotRef} options={{ format: "jpg", quality: 0.9 }}>
                                {allQRs.map((student, index) => (
                                    <View key={index} style={styles.studentContainer}>
                                        <Text style={styles.studentName}>{student.name}</Text>
                                        <View style={styles.qrContainer}>
                                            {student.qrs.map((qr, i) => (
                                                <View key={i} style={styles.qrBox}>
                                                    <Text style={styles.qrText}>
                                                        {student.name} ({qr.answer})
                                                    </Text>
                                                    <Image source={{ uri: qr.uri }} style={styles.qrImage} />
                                                    <Text style={styles.qrFooterText}>
                                                        {student.name} ({qr.answer})
                                                    </Text>
                                                </View>
                                            ))}
                                        </View>
                                    </View>
                                ))}
                            </ViewShot>

                        </ScrollView>

                        <View style={{ flexDirection: 'row', justifyContent: 'space-between', marginTop: 12 }}>
                            <TouchableOpacity
                                onPress={() => setVisible(false)}
                                style={styles.button}
                            >
                                <Text style={styles.buttonText}>‚ùå ƒê√≥ng l·∫°i</Text>
                            </TouchableOpacity>
                            <TouchableOpacity
                                onPress={downloadAllQRs}
                                style={styles.button}
                            >
                                <Text style={styles.buttonText}>üì• T·∫£i xu·ªëng t·∫•t c·∫£</Text>
                            </TouchableOpacity>
                        </View>
                    </View>
                </View>
            </Modal>
        </View >
    )
};